#!/usr/bin/env ruby
# -*- encoding: binary -*-
# this is to remain compatible with the unused_port function in the
# Unicorn test/test_helper.rb file
require 'socket'
require 'tmpdir'

default_port = 8080
addr = ENV['UNICORN_TEST_ADDR'] || '127.0.0.1'
port = sock = lock_path = nil

begin
  sock = TCPServer.new(addr, 0)
  port = sock.addr[1]

  # since we'll end up closing the random port we just got, there's a race
  # condition could allow the random port we just chose to reselect itself
  # when running tests in parallel with gmake.  Create a lock file while
  # we have the port here to ensure that does not happen.
  lock_path = "#{Dir::tmpdir}/unicorn_test.#{addr}:#{port}.lock"
  lock = File.open(lock_path, File::WRONLY|File::CREAT|File::EXCL, 0600)
rescue Errno::EEXIST
  sock.close rescue nil
  retry
end
sock.close rescue nil
puts %Q(listen=#{addr}:#{port} T_RM_LIST="$T_RM_LIST #{lock_path}")
