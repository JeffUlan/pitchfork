require 'rake'
require 'rake/testtask'
require 'rake/clean'
require 'rake/gempackagetask'
require 'rake/rdoctask'
require 'tools/rakehelp'
require 'tools/freebasic'
require 'fileutils'
include FileUtils

setup_tests
setup_clean ["pkg", "lib/*.bundle", "*.gem", ".config"]

setup_rdoc ['README', 'LICENSE', 'COPYING', 'lib/**/*.rb', 'doc/**/*.rdoc']

desc "Does a full compile, test run"
task :default => [:compile, :test]

GEM_VERSION = "0.3.0"
GEM_NAME = "mongrel_service"

desc "Compile native code"
task :compile => [:native_lib, :native_service]

# ServiceFB namespace (lib)
namespace :lib do
  project_task 'servicefb' do
    lib       'ServiceFB'
    build_to  'lib'

    define    'SERVICEFB_DEBUG_LOG' unless ENV['RELEASE'] 
    source    'lib/ServiceFB/ServiceFB.bas'
  end
  
  project_task 'servicefb_utils' do
    lib       'ServiceFB_Utils'
    build_to  'lib'

    define    'SERVICEFB_DEBUG_LOG' unless ENV['RELEASE']
    source    'lib/ServiceFB/ServiceFB_Utils.bas'
  end
end
# add lib namespace to global tasks
#include_projects_of :lib
task :native_lib => "lib:build"
task :clean => "lib:clobber"

# mongrel_service (native)
namespace :native do
  project_task  'mongrel_service' do
    executable  'mongrel_service'
    build_to    'bin'
    
    define      'DEBUG_LOG' unless ENV['RELEASE']
    
    main        'native/mongrel_service.bas'
    source      'native/process.bas'
    
    # including the precompiled file show warnings when linking with
    # ld, due special m$ directives in the obj file
    # will solve that later, when migrate the asm part of code to gcc
    # source      'native/send_signal.o'
    
    lib_path    'lib'
    library     'ServiceFB', 'ServiceFB_Utils'
    # library     'send_signal'
    library     'user32', 'advapi32', 'psapi'
  end
end
#include_projects_of :native
task :native_service => "native:build"
task :clean => "native:clobber"

task :package => [:clean, :compile, :test]

setup_gem(GEM_NAME, GEM_VERSION) do |spec|
  spec.summary = "Mongrel Native Win32 Service Plugin for Rails"
  spec.summary += " (debug build)" unless ENV['RELEASE'] 
  spec.description = "This plugin offer native win32 services for rails, powered by Mongrel."
  spec.author = "Luis Lavena"
  spec.platform = Gem::Platform::WIN32
  
  spec.files -= Dir["bin/**/*"]
  spec.files -= Dir["**/*.{o,a}"]
  spec.files += Dir["native/**/*.{bas,bi}"]
  spec.files += ["bin/mongrel_service.exe"]
  
  spec.add_dependency('gem_plugin', '>= 0.2.1')
  spec.add_dependency('mongrel', '>= 0.3.12.4')
  spec.add_dependency('win32-service', '>= 0.5.0')
  
  spec.files += Dir.glob("resources/**/*")
end

task :install => [:test, :package] do
  sh %{gem install pkg/#{name}-#{version}.gem}
end

task :uninstall => [:clean] do
  sh %{gem uninstall #{name}}
end

